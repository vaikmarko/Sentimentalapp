<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHR6MC542E"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-GHR6MC542E');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Your Story - Sentimental</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #8639E8 0%, #FF6B6B 100%);
        }

        .btn-primary {
            background-color: #8639E8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #7529D8;
            box-shadow: 0 10px 15px rgba(134, 57, 232, 0.2);
        }
        
        .message {
            padding: 10px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease-out;
        }

        .user {
            background-color: #8639E8;
            color: white;
            margin-left: auto;
        }

        .bot {
            background-color: #f3f4f6;
            color: #374151;
            margin-right: auto;
        }

        #chat-messages {
            overflow-y: auto;
            max-height: 400px;
            padding-bottom: 10px;
        }

        #chat-container {
            border-radius: 16px;
            border: 1px solid #e5e7eb;
        }
        
        .typing-indicator {
            display: inline-block;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #8639E8;
            display: inline-block;
            border-radius: 50%;
            opacity: 0.6;
            animation: typing 1s infinite;
            margin: 0 2px;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .music-style-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .music-style-option:hover {
            transform: translateY(-5px);
        }
        
        .music-style-option.selected {
            border: 2px solid #8639E8;
            transform: translateY(-5px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white sticky top-0 z-50 shadow-sm py-4 px-6">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-3xl font-bold text-purple-600">Sentimental</a>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-12">
        <div class="max-w-3xl mx-auto">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold mb-4">Share Your Story</h1>
                <p class="text-xl text-gray-600">
                    Tell us something meaningful from your life. Our AI will guide you through the process.
                </p>
            </div>
            
            <!-- Chat Interface -->
            <div id="chat-container" class="bg-white shadow-lg rounded-xl overflow-hidden mb-10">
                <div id="chat-messages" class="p-6 space-y-4 h-96 overflow-y-auto">
                    <!-- Messages will appear here -->
                    <div class="message bot">
                        Hello! I'm here to help you share your story. What personal experience would you like to tell me about today?
                    </div>
                </div>
                
                <div class="border-t border-gray-200 p-4 bg-gray-50">
                    <div class="flex items-center">
                        <textarea id="user-input" placeholder="Type your message here..." class="flex-grow p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" rows="2"></textarea>
                        <button id="send-button" class="ml-4 btn-primary">
                            <i class="fas fa-paper-plane mr-2"></i>Send
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Options Section (Initially Hidden) -->
            <div id="options-section" class="bg-white shadow-lg rounded-xl p-8 mb-10" style="display: none;">
                <h2 class="text-2xl font-bold mb-6 text-center">Customize Your Experience</h2>
                
                <div class="mb-8">
                    <label class="block text-gray-700 font-medium mb-4">Choose a Music Style:</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="music-style-option bg-gray-50 rounded-lg p-4 text-center hover:shadow-md selected" data-style="acoustic">
                            <div class="w-12 h-12 mx-auto mb-2 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-guitar text-purple-600"></i>
                            </div>
                            <h4 class="font-semibold">Acoustic</h4>
                            <p class="text-sm text-gray-500">Folksy, organic sounds</p>
                        </div>
                        <div class="music-style-option bg-gray-50 rounded-lg p-4 text-center hover:shadow-md" data-style="electronic">
                            <div class="w-12 h-12 mx-auto mb-2 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-bolt text-purple-600"></i>
                            </div>
                            <h4 class="font-semibold">Electronic</h4>
                            <p class="text-sm text-gray-500">Modern digital beats</p>
                        </div>
                        <div class="music-style-option bg-gray-50 rounded-lg p-4 text-center hover:shadow-md" data-style="classical">
                            <div class="w-12 h-12 mx-auto mb-2 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-music text-purple-600"></i>
                            </div>
                            <h4 class="font-semibold">Classical</h4>
                            <p class="text-sm text-gray-500">Orchestral elegance</p>
                        </div>
                        <div class="music-style-option bg-gray-50 rounded-lg p-4 text-center hover:shadow-md" data-style="jazz">
                            <div class="w-12 h-12 mx-auto mb-2 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-saxophone text-purple-600"></i>
                            </div>
                            <h4 class="font-semibold">Jazz</h4>
                            <p class="text-sm text-gray-500">Smooth improvisations</p>
                        </div>
                        <div class="music-style-option bg-gray-50 rounded-lg p-4 text-center hover:shadow-md" data-style="rock">
                            <div class="w-12 h-12 mx-auto mb-2 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-drum text-purple-600"></i>
                            </div>
                            <h4 class="font-semibold">Rock</h4>
                            <p class="text-sm text-gray-500">Powerful and energetic</p>
                        </div>
                        <div class="music-style-option bg-gray-50 rounded-lg p-4 text-center hover:shadow-md" data-style="ambient">
                            <div class="w-12 h-12 mx-auto mb-2 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-water text-purple-600"></i>
                            </div>
                            <h4 class="font-semibold">Ambient</h4>
                            <p class="text-sm text-gray-500">Atmospheric textures</p>
                        </div>
                    </div>
                    <input type="hidden" id="music-style" value="acoustic">
                </div>
                
                <div class="mb-8">
                    <label class="block text-gray-700 font-medium mb-2">Upload Your Photo (Optional):</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="photo-upload" accept="image/*" class="hidden">
                        <label for="photo-upload" class="cursor-pointer">
                            <div id="upload-icon" class="mx-auto mb-4">
                                <i class="fas fa-cloud-upload-alt text-4xl text-purple-600"></i>
                            </div>
                            <div id="upload-text">
                                <p class="text-gray-700 mb-1">Drag and drop a file or click to browse</p>
                                <p class="text-sm text-gray-500">JPG, PNG, or GIF (max 5MB)</p>
                            </div>
                            <div id="upload-preview" class="mt-4" style="display: none;">
                                <img id="preview-image" class="max-h-40 mx-auto rounded">
                                <p class="text-sm text-green-600 mt-2">Photo selected</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="submit-story" class="btn-primary text-lg px-10 py-4">
                        <i class="fas fa-paper-plane mr-2"></i>Submit My Story
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12 px-6 mt-auto">
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-8 md:mb-0">
                    <a href="/" class="text-2xl font-bold">Sentimental</a>
                    <p class="mt-2 text-gray-400">Your Life, Your Story.</p>
                </div>
            </div>
            <hr class="border-gray-800 my-8">
            <div class="text-center text-gray-400">
                <p>&copy; 2025 Sentimental. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <script>
        // Chat variables
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const optionsSection = document.getElementById('options-section');
        const submitStoryButton = document.getElementById('submit-story');
        const photoUpload = document.getElementById('photo-upload');
        const uploadPreview = document.getElementById('upload-preview');
        const previewImage = document.getElementById('preview-image');
        const uploadIcon = document.getElementById('upload-icon');
        const uploadText = document.getElementById('upload-text');
        const musicStyleOptions = document.querySelectorAll('.music-style-option');
        const musicStyleInput = document.getElementById('music-style');
        
        // Firebase Function URL (replace with your actual URL)
        const CLOUD_FUNCTION_URL = "https://us-central1-sentimental-28cc9.cloudfunctions.net/chatWithOpenAI";
        
        // Store conversation history
        let conversationHistory = [
            {role: "system", content: "You are a compassionate AI assistant at Sentimental, guiding users to share meaningful personal stories. Help them open up about significant experiences that shaped them. Ask thoughtful questions to gradually get deeper insights. Focus on emotions, key moments, and personal growth. After about 4-5 exchanges when you've gathered enough story material, gently suggest they're ready to customize and submit their story. Your tone should be warm, understanding, and encouraging. Avoid clinical language or overly generic responses. If a user shares something sensitive, acknowledge their trust in sharing it. Don't rush them - let the conversation flow naturally."},
            {role: "assistant", content: "Hello! I'm here to help you share your story. What personal experience would you like to tell me about today?"}
        ];
        
        // Get user name and email from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const userName = urlParams.get('name');
        const userEmail = urlParams.get('email');
        
        // Message exchange counter
        let messageCount = 0;
        let userPhotoFile = null;
        
        // Handle music style selection
        musicStyleOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                musicStyleOptions.forEach(opt => opt.classList.remove('selected'));
                // Add selected class to clicked option
                this.classList.add('selected');
                // Update hidden input value
                musicStyleInput.value = this.dataset.style;
            });
        });
        
        // Handle photo upload
        photoUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check file size (limit to 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Please choose a file smaller than 5MB');
                this.value = '';
                return;
            }
            
            userPhotoFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                uploadPreview.style.display = 'block';
                uploadIcon.style.display = 'none';
                uploadText.style.display = 'none';
            };
            reader.readAsDataURL(file);
        });
        
        // Helper function to create typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'bot', 'typing-indicator-container');
            typingDiv.id = 'typing-indicator';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('typing-indicator');
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            
            typingDiv.appendChild(typingIndicator);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                chatMessages.removeChild(typingIndicator);
            }
        }
        
        // Send button click event
        sendButton.addEventListener('click', async function() {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;
            
            // Disable input while processing
            userInput.disabled = true;
            sendButton.disabled = true;
            
            // Add user message to chat
            appendMessage('user', userMessage);
            userInput.value = '';
            
            // Add to conversation history
            conversationHistory.push({role: "user", content: userMessage});
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Call Firebase Function
                const response = await fetch(CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: conversationHistory
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                if (data.message && data.message.content) {
                    const aiMessage = data.message.content;
                    
                    // Add AI response to chat
                    appendMessage('bot', aiMessage);
                    conversationHistory.push({role: "assistant", content: aiMessage});
                    
                    // Increment message counter
                    messageCount++;
                    
                    // Show options section after 4 exchanges
                    if (messageCount >= 4) {
                        optionsSection.style.display = 'block';
                        
                        // Scroll to options section after a short delay
                        setTimeout(() => {
                            optionsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 500);
                    }
                } else {
                    appendMessage('bot', "I'm having trouble generating a response. Please try again.");
                }
            } catch (error) {
                console.error("Error calling backend:", error);
                removeTypingIndicator();
                appendMessage('bot', "I'm sorry, there was an error processing your message. Please try again.");
            }
            
            // Re-enable input
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        });
        
        // Allow sending with Enter key
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendButton.click();
            }
        });
        
        // Function to add messages to the chat
        function appendMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Submit story button
        submitStoryButton.addEventListener('click', async function() {
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
            
            const musicStyle = musicStyleInput.value;
            
            try {
                // Create a unique ID for this submission
                const submissionId = `${Date.now()}-${userName.replace(/\s+/g, '-').toLowerCase()}`;
                
                // Prepare story data
                const storyData = {
                    id: submissionId,
                    name: userName,
                    email: userEmail,
                    conversation: conversationHistory,
                    musicStyle: musicStyle,
                    submittedAt: new Date().toISOString(),
                    status: 'new'
                };
                
                // If there's a photo, upload it to Firebase Storage
                if (userPhotoFile) {
                    const storageRef = storage.ref(`user-photos/${submissionId}`);
                    await storageRef.put(userPhotoFile);
                    
                    // Get the download URL
                    const photoURL = await storageRef.getDownloadURL();
                    storyData.photoURL = photoURL;
                }
                
                // Save to Firestore
                await db.collection('submissions').doc(submissionId).set(storyData);
                
                // Redirect to thank you page
                window.location.href = "thanks.html?submitted=true";
                
            } catch (error) {
                console.error("Error submitting story:", error);
                alert("There was an error submitting your story. Please try again.");
                
                // Reset button
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit My Story';
            }
        });
    </script>
</body>
</html>
