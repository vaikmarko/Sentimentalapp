<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GHR6MC542E"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-GHR6MC542E');
  </script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sentimental - Share Your Story</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f7f8;
      color: #343541;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .navbar {
      background: white;
      padding: 12px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-weight: 700;
      font-size: 20px;
      color: #8639E8;
      text-decoration: none;
    }
    .chat-container {
      padding: 30px 20px;
      max-width: 700px;
      margin: 0 auto;
    }
    .message {
      padding: 12px 20px;
      margin-bottom: 12px;
      border-radius: 12px;
      max-width: 90%;
    }
    .message.bot {
      background-color: #f3f4f6;
      color: #1f2937;
      margin-right: auto;
    }
    .message.user {
      background-color: #8639E8;
      color: white;
      margin-left: auto;
    }
    .input-area {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .input-area textarea {
      flex-grow: 1;
      border-radius: 8px;
      padding: 12px;
      border: 1px solid #ccc;
    }
    .btn-primary {
      background-color: #8639E8;
      color: white;
      padding: 0 20px;
      border-radius: 8px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="/" class="logo">Sentimental</a>
  </div>

  <div class="chat-container">
    <div id="chat-messages">
      <div class="message bot">
        Welcome! What personal experience would you like to share with me today?
      </div>
    </div>
    <div class="input-area">
      <textarea id="user-input" rows="2" placeholder="Type your message..."></textarea>
      <button id="send-button" class="btn-primary">Send</button>
    </div>
  </div>

  <div class="chat-container" id="options-section" style="display: none;">
    <label class="block font-semibold mb-2">Choose a Format:</label>
    <select id="format-select" class="w-full p-3 border rounded mb-4">
      <option value="blog">Blog Post</option>
      <option value="song">Song</option>
      <option value="poem">Poem</option>
      <option value="video">Video</option>
      <option value="insight">Therapeutic Insight</option>
    </select>
    <label class="block font-semibold mb-2">Your Email:</label>
    <input type="email" id="email-input" class="w-full p-3 border rounded mb-4" placeholder="you@example.com" />
    <button id="submit-button" class="btn-primary w-full">Submit Story</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCSoWmKZRDpXF5MlgWKEV6kWHc5xFMMm_I",
      authDomain: "sentimental-f95e6.firebaseapp.com",
      projectId: "sentimental-f95e6",
      storageBucket: "sentimental-f95e6.appspot.com",
      messagingSenderId: "319737737925",
      appId: "1:319737737925:web:1de7aa284a63ad9f9eb6ac",
      measurementId: "G-9WFK8R9P9T"
    };

    firebase.initializeApp(firebaseConfig);
    const functions = firebase.functions();

    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const optionsSection = document.getElementById('options-section');
    const submitButton = document.getElementById('submit-button');
    const formatSelect = document.getElementById('format-select');
    const emailInput = document.getElementById('email-input');

    let messageCount = 0;
    let conversation = [
      { role: "system", content: "You are a helpful assistant who collects meaningful personal stories from users." },
      { role: "assistant", content: "Welcome! What personal experience would you like to share with me today?" }
    ];

    sendButton.addEventListener('click', async () => {
      const message = userInput.value.trim();
      if (!message) return;

      appendMessage('user', message);
      conversation.push({ role: 'user', content: message });
      userInput.value = '';
      messageCount++;

      const chatFn = functions.httpsCallable("chatCompletion");
      try {
        const res = await chatFn({ messages: conversation });
        const reply = res.data.reply;
        conversation.push({ role: 'assistant', content: reply });
        appendMessage('bot', reply);
        if (messageCount >= 4) optionsSection.style.display = 'block';
      } catch (err) {
        console.error("Error calling function:", err);
      }
    });

    function appendMessage(role, content) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.textContent = content;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    submitButton.addEventListener('click', async () => {
      const format = formatSelect.value;
      const email = emailInput.value.trim();
      if (!email || !format) return alert("Please enter your email and choose a format.");

      const storyData = {
        email,
        format,
        conversation,
        submittedAt: new Date().toISOString(),
      };

      try {
        const saveFn = functions.httpsCallable("saveStory");
        await saveFn(storyData);
        alert("Story submitted successfully! Thank you.");
        window.location.reload();
      } catch (err) {
        console.error("Error saving story:", err);
        alert("Submission failed.");
      }
    });
  </script>
</body>
</html>
