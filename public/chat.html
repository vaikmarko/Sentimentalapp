<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Sentimental</title>
  
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9f9fb;
      color: #343541;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .navbar {
      background: white;
      padding: 16px 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      display: flex;
      justify-content: flex-start;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      margin-left: -20px;
      margin-right: -20px;
      margin-top: -20px;
      width: calc(100% + 40px);
    }
    .logo {
      font-weight: 700;
      font-size: 24px;
      color: #8639E8;
      text-decoration: none;
      letter-spacing: 0.5px;
    }
    
    .new-chat-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background-color: #f3f0ff;
      border: 1px solid #e5dbff;
      color: #8639E8;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .chat-container {
      flex: 1;
      padding: 24px 0;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 0 20px;
      margin-bottom: 20px;
    }
    
    .message-group {
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
    }
    
    .message-group.bot {
      align-items: flex-start;
    }
    
    .message-group.user {
      align-items: flex-end;
    }
    
    .bot-info {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .bot-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 12px;
      background-color: #8639E8;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .bot-name {
      font-weight: 600;
      font-size: 15px;
      color: #424250;
    }
    
    .message-bubble {
      padding: 14px 18px;
      border-radius: 18px;
      max-width: 85%;
      position: relative;
      margin-bottom: 2px;
      line-height: 1.5;
      font-weight: normal;
    }
    
    .message-bubble.bot {
      background-color: white;
      color: #1f2937;
      border: 1px solid #e9e9ef;
      border-bottom-left-radius: 4px;
    }
    
    .message-bubble.user {
      background-color: #8639E8;
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .message-time {
      font-size: 12px;
      color: #71717a;
      margin-top: 6px;
      padding: 0 12px;
    }
    
    .input-container {
      position: relative;
      background-color: white;
      border-top: 1px solid #e9e9ef;
      padding: 16px 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
    }
    
    .input-wrapper {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
    }
    
    .user-input {
      flex-grow: 1;
      border-radius: 24px;
      padding: 14px 60px 14px 20px;
      border: 1px solid #e4e4e7;
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      line-height: 1.5;
      resize: none;
      max-height: 150px;
      min-height: 50px;
      overflow-y: auto;
    }
    
    .user-input:focus {
      outline: none;
      border-color: #a677e9;
    }
    
    .send-button {
      position: absolute;
      right: 10px;
      bottom: 10px;
      background-color: #8639E8;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }
    
    .prompt-chips {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px;
    }
    
    .prompt-chip {
      background-color: #f3f0ff;
      border: 1px solid #e5dbff;
      color: #8639E8;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: normal;
    }
    
    .highlight {
      color: #8639E8;
      font-weight: normal;
    }
    
    @media (max-width: 640px) {
      .message-bubble {
        max-width: 90%;
      }
      
      .prompt-chip {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="/" class="logo">Sentimental</a>
  </div>
  <div class="navbar" style="display: none">
    <!-- (old navbar hidden, see below) -->
  </div>
  <div style="display: flex; align-items: center; margin-bottom: 0;">
    <!-- Generate Story button removed: story now generates automatically -->
    <button id="new-chat-button" class="new-chat-button" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      New Chat
    </button>
    <button id="generate-story-btn" class="new-chat-button" style="margin-left: 12px; display: none;">
      Genereeri minu lugu
    </button>
  </div>
  <div class="chat-container">
    <div id="progress-container" style="width: 100%; height: 10px; background: #e4e4e7; border-radius: 5px; margin-bottom: 16px;">
      <div id="progress-bar" style="height: 100%; width: 0%; background: #8639E8; border-radius: 5px; transition: width 0.3s ease;"></div>
    </div>
    <div id="messages-container" class="messages-container">
      <!-- Welcome message -->
      <div class="message-group bot">
        <div class="bot-info">
          <div class="bot-avatar"><span>S</span></div>
          <div class="bot-name">Miko</div>
        </div>
        <div class="message-bubble bot welcome-message">
          <p>Hello, I'm <span class="highlight">Miko</span>, your reflection companion. 🌱</p>

          <p>You are not a problem to solve, but a miracle to explore. I'm here to help you find meaning in your experiences and amplify your voice.</p>
          
          <p>What's on your mind today? You could share:</p>
          
          <p>A feeling you've been experiencing lately<br>
          A situation you're trying to understand better<br>
          Something meaningful that happened to you<br>
          A pattern you've noticed in your life<br>
          A question you're holding</p>
          
          <p>Let's begin wherever feels natural for you.</p>
          
          <div class="prompt-chips">
            <div class="prompt-chip" onclick="usePrompt(this)">I've been feeling something lately that I can't quite define...</div>
            <div class="prompt-chip" onclick="usePrompt(this)">I'm trying to make sense of a situation where...</div>
            <div class="prompt-chip" onclick="usePrompt(this)">Something meaningful happened to me recently...</div>
            <div class="prompt-chip" onclick="usePrompt(this)">I've noticed a pattern in my life that...</div>
            <div class="prompt-chip" onclick="usePrompt(this)">I've been wondering about...</div>
          </div>
        </div>
        <div class="message-time" id="welcome-time"></div>
      </div>
    </div>
    
    <div class="input-container">
      <div class="input-wrapper">
        <textarea id="user-input" class="user-input" placeholder="Share what's on your mind..." rows="1"></textarea>
        <button id="send-button" class="send-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCSoWmKZRDpXF5MlgWKEV6kWHc5xFMMm_I",
      authDomain: "sentimental-f95e6.firebaseapp.com",
      projectId: "sentimental-f95e6",
      storageBucket: "sentimental-f95e6.appspot.com",
      messagingSenderId: "319737737925",
      appId: "1:319737737925:web:1de7aa284a63ad9f9eb6ac",
      measurementId: "G-9WFK8R9P9T"
    };
    // Ensure config values are present (basic check)
    if (
      !firebaseConfig.apiKey ||
      !firebaseConfig.authDomain ||
      !firebaseConfig.projectId ||
      !firebaseConfig.appId
    ) {
      console.error("Missing Firebase configuration. Please provide all config values.");
      alert("Missing Firebase configuration. Please contact support.");
    } else {
      // Only initialize if not already initialized
      if (!firebase.apps || !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      } else if (firebase.apps && firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
      }
    }

    // --- Firestore ühenduse test lehe alguses ---
    firebase.firestore().collection('test').add({alive: true, ts: Date.now()})
      .then(doc => {console.log("[TEST] Firestore ühendus OK", doc.id)})
      .catch(e => {console.error("[TEST] Firestore ühendus FAIL", e); alert("Firestore ühendus FAIL: " + e.message)});
    
    // Setup basic elements
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const messagesContainer = document.getElementById('messages-container');
    const welcomeTime = document.getElementById('welcome-time');
    // Generate Story button no longer needed, removed from DOM
    
    // Set the current time for the welcome message
    welcomeTime.textContent = formatTime();
    
    // Let's keep everything super simple
    // Initialize conversation array
    let conversation = [{
      role: 'system',
      content: 'You are Miko, an empathetic reflection companion. Your goal is to help users explore their experiences, find meaning, and amplify their authentic voice. Ask thoughtful questions to help users gain insights. Be warm, supportive, and occasionally use metaphors to illustrate points. Keep responses concise (2 paragraphs max) and always end with a gentle question to encourage further reflection. Avoid being overly analytical or clinical - focus on emotional understanding and meaning-making.'
    }, {
      role: 'assistant',
      content: "Hello, I'm Miko, your reflection companion. You are not a problem to solve, but a miracle to explore. I'm here to help you find meaning in your experiences and amplify your voice. What's on your mind today?"
    }];

    // Firestore story document ID for this chat session
    let storyDocId = null;
    // Format the time
    function formatTime() {
      const now = new Date();
      let hours = now.getHours();
      let minutes = now.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      
      hours = hours % 12;
      hours = hours ? hours : 12;
      minutes = minutes < 10 ? '0' + minutes : minutes;
      
      return `${hours}:${minutes} ${ampm}`;
    }
    
    // Simple function to add a message
    function addMessage(sender, text) {
      // Create message group
      const messageGroup = document.createElement('div');
      messageGroup.className = `message-group ${sender}`;
      
      // If it's the bot, add avatar and name
      if (sender === 'bot') {
        const botInfo = document.createElement('div');
        botInfo.className = 'bot-info';
        
        const avatar = document.createElement('div');
        avatar.className = 'bot-avatar';
        avatar.innerHTML = '<span>S</span>';
        
        const name = document.createElement('div');
        name.className = 'bot-name';
        name.textContent = 'Miko';
        
        botInfo.appendChild(avatar);
        botInfo.appendChild(name);
        messageGroup.appendChild(botInfo);
      }
      
      // Create message bubble
      const messageBubble = document.createElement('div');
      messageBubble.className = `message-bubble ${sender}`;
      messageBubble.textContent = text;
      messageGroup.appendChild(messageBubble);
      
      // Add timestamp
      const timeElement = document.createElement('div');
      timeElement.className = 'message-time';
      timeElement.textContent = formatTime();
      messageGroup.appendChild(timeElement);
      
      // Add to container
      messagesContainer.appendChild(messageGroup);
      
      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Use a prompt chip text
    function usePrompt(element) {
      userInput.value = element.textContent;
      userInput.focus();
    }
    
    // Simple function to handle sending a message
    // --- Automatic story generation state ---
    let storyGenerationStarted = false; // prevents duplicate generation
    let storyGenerationLoading = false; // for showing loading state
    let storyCheckInterval = null; // interval for checking story readiness
    let storyGeneratedRedirected = false; // prevent duplicate redirects

    function showGeneratingStoryLoading() {
      // Show a loading animation or message in the chat UI
      if (!document.getElementById('story-loading-indicator')) {
        const messageGroup = document.createElement('div');
        messageGroup.className = 'message-group bot';
        messageGroup.id = 'story-loading-indicator';

        const botInfo = document.createElement('div');
        botInfo.className = 'bot-info';

        const avatar = document.createElement('div');
        avatar.className = 'bot-avatar';
        avatar.innerHTML = '<span>S</span>';

        const name = document.createElement('div');
        name.className = 'bot-name';
        name.textContent = 'Miko';

        botInfo.appendChild(avatar);
        botInfo.appendChild(name);
        messageGroup.appendChild(botInfo);

        const loadingBubble = document.createElement('div');
        loadingBubble.className = 'message-bubble bot';
        loadingBubble.innerHTML = '<span class="loading-dots">Generating your story<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></span>';
        messageGroup.appendChild(loadingBubble);
        messagesContainer.appendChild(messageGroup);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }
    function removeGeneratingStoryLoading() {
      const indicator = document.getElementById('story-loading-indicator');
      if (indicator) {
        indicator.remove();
      }
    }

    // Utility: Check if conversation is ready for story generation (at least 2 user and 2 assistant messages)
    function isReadyForStoryGeneration() {
      const userMsgs = conversation.filter(m => m.role === "user").length;
      const assistantMsgs = conversation.filter(m => m.role === "assistant").length;
      return userMsgs >= 2 && assistantMsgs >= 2;
    }

    // Checks Firestore for story (title and text) and redirects if ready
    function pollForStoryAndRedirect() {
      if (!storyDocId || storyGeneratedRedirected) return;
      const docRef = firebase.firestore().collection("stories").doc(storyDocId);
      docRef.get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          // Check if story is generated (title and text present)
          if (data && data.title && data.text) {
            storyGeneratedRedirected = true;
            removeGeneratingStoryLoading();
            // Redirect to story.html with storyId
            const targetUrl = new URL(window.location.origin + "/story.html");
            targetUrl.searchParams.set("storyId", storyDocId);
            window.location.href = targetUrl.toString();
          } else {
            // Still generating, show loading
            showGeneratingStoryLoading();
          }
        } else {
          showGeneratingStoryLoading();
        }
      }).catch(e => {
        console.error("Error polling for story:", e);
        showGeneratingStoryLoading();
      });
    }

    // Starts story generation (calls generateFullStory) and polls for result
    function autoGenerateStory() {
      if (storyGenerationStarted || !storyDocId) return;
      storyGenerationStarted = true;
      storyGenerationLoading = true;
      showGeneratingStoryLoading();
      // Call backend function to generate story
      const generate = firebase.functions().httpsCallable('generateFullStory');
      generate({ storyId: storyDocId }).then(res => {
        // Start polling for result
        if (!storyCheckInterval) {
          storyCheckInterval = setInterval(pollForStoryAndRedirect, 1500);
        }
      }).catch(err => {
        storyGenerationStarted = false;
        storyGenerationLoading = false;
        console.error("Error generating story:", err);
        removeGeneratingStoryLoading();
        alert("Something went wrong generating the story. Please try again.");
      });
    }

    // Each time a message is sent/received, check if story should be generated
    function checkAndTriggerStoryGeneration() {
      if (isReadyForStoryGeneration() && !storyGenerationStarted) {
        autoGenerateStory();
      }
    }

    // --- END: automatic story generation logic ---

    function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      // Add user message to UI
      addMessage('user', message);

      // Add to conversation array
      conversation.push({ role: 'user', content: message });

      // Clear input
      userInput.value = '';

      // Show typing indicator if not already present
      if (!document.getElementById('typing-indicator')) {
        const messageGroup = document.createElement('div');
        messageGroup.className = 'message-group bot';
        messageGroup.id = 'typing-indicator';

        const botInfo = document.createElement('div');
        botInfo.className = 'bot-info';

        const avatar = document.createElement('div');
        avatar.className = 'bot-avatar';
        avatar.innerHTML = '<span>S</span>';

        const name = document.createElement('div');
        name.className = 'bot-name';
        name.textContent = 'Miko';

        botInfo.appendChild(avatar);
        botInfo.appendChild(name);
        messageGroup.appendChild(botInfo);

        const typingBubble = document.createElement('div');
        typingBubble.className = 'message-bubble bot';
        typingBubble.textContent = 'Typing...';
        messageGroup.appendChild(typingBubble);

        messagesContainer.appendChild(messageGroup);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Process the message (try Firebase function)
      try {
        // Check Firestore availability before use
        if (
          typeof firebase !== 'undefined' &&
          firebase.functions &&
          firebase.firestore &&
          typeof firebase.firestore === "function"
        ) {
          // Debug: log outgoing conversation
          console.log("Sending to chatCompletion:", conversation);
          const chatCompletion = firebase.functions().httpsCallable('chatCompletion');
          chatCompletion({ messages: conversation })
            .then(result => {
              if (result && result.data && result.data.reply) {
                // Remove typing indicator
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                  messagesContainer.removeChild(typingIndicator);
                }

                // Add bot response
                addMessage('bot', result.data.reply);

                // Add to conversation BEFORE Firestore update so it's stored
                conversation.push({ role: 'assistant', content: result.data.reply });

                // --- Firestore story saving START ---
                try {
                  const user = firebase.auth().currentUser;
                  const storyText = conversation
                    .filter(msg => msg.role === 'user')
                    .map(msg => msg.content)
                    .join(' ');

                  const storyData = {
                    userId: user ? user.uid : null,
                    email: user ? user.email : null,
                    text: storyText,
                    gptGenerated: result.data.reply,
                    formatsGenerated: {},
                    status: "draft",
                    public: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    conversation: JSON.parse(JSON.stringify(conversation))
                  };

                  const storiesRef = firebase.firestore().collection("stories");
                  // Only generate storyDocId once, and reuse it
                  if (!storyDocId) {
                    const docRef = storiesRef.doc();
                    storyDocId = docRef.id;
                    console.log("Firestore save START (create)", storyDocId, storyData);
                    docRef.set(storyData)
                      .then(() => {
                        console.log("Firestore save OK (create)", storyDocId);
                        // After saving, check for story generation
                        checkAndTriggerStoryGeneration();
                      })
                      .catch(error => {
                        console.error("Firestore save FAIL (create)", error);
                        alert("Firestore save FAIL (create): " + error.message);
                      });
                  } else {
                    console.log("Firestore save START (update)", storyDocId, storyData);
                    storiesRef.doc(storyDocId).update(storyData)
                      .then(() => {
                        console.log("Firestore save OK (update)", storyDocId);
                        // After saving, check for story generation
                        checkAndTriggerStoryGeneration();
                      })
                      .catch(error => {
                        console.error("Firestore save FAIL (update)", error);
                        alert("Firestore save FAIL (update): " + error.message);
                      });
                  }
                } catch (e) {
                  console.error("Error preparing or saving story to Firestore:", e);
                  alert("Error preparing or saving story to Firestore: " + e.message);
                }
                // --- Firestore story saving END ---
                analyzeProgress();
                // Also check for story generation (in case Firestore update is async)
                checkAndTriggerStoryGeneration();
              } else {
                // Remove typing indicator if no reply
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                  messagesContainer.removeChild(typingIndicator);
                }
                addMessage('bot', "Sorry, I couldn't generate a reply right now.");
                console.warn("AI did not return a reply!", result);
                alert("AI did not return a reply! Vaata konsooli.");
              }
            })
            .catch(error => {
              console.error("Error calling Firebase function chatCompletion:", error.message || error);
              alert("Error calling Firebase function chatCompletion: " + (error.message || error));
              // Remove typing indicator
              const typingIndicator = document.getElementById('typing-indicator');
              if (typingIndicator) {
                messagesContainer.removeChild(typingIndicator);
              }

              // Add fallback response
              const fallbackReply = "I'm having trouble connecting right now. Please try again in a moment.";
              addMessage('bot', fallbackReply);
            });
        } else {
          // Fallback for no Firebase
          setTimeout(() => {
            // Remove typing indicator
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
              messagesContainer.removeChild(typingIndicator);
            }

            // Add a simple response
            const reply = "I understand. Can you tell me more about that?";
            addMessage('bot', reply);

            // Add to conversation
            conversation.push({ role: 'assistant', content: reply });
            // After fallback, check for story generation
            checkAndTriggerStoryGeneration();
          }, 1000);
        }
      } catch (error) {
        console.error("Error processing message:", error);
        // Remove typing indicator
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
          messagesContainer.removeChild(typingIndicator);
        }

        // Add fallback response
        const fallbackReply = "Something went wrong. Please try again.";
        addMessage('bot', fallbackReply);
      }
    }
    
    // Set up event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Set progress bar to 0% on load
      const progressBar = document.getElementById("progress-bar");
      if (progressBar) {
        progressBar.style.width = "0%";
      }
      // Auto-resize textarea
      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight < 150) ? this.scrollHeight + 'px' : '150px';
      });
      
      // Send on Enter key
      userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Send button click
      sendButton.addEventListener('click', sendMessage);
      
      // New chat button
      document.getElementById('new-chat-button').addEventListener('click', function() {
        // Just reload the page for simplicity
        window.location.reload();
      });
    });
    // Analyze progress using Firebase Functions
    let progress = 0;
function analyzeProgress() {
  if (
    typeof firebase !== 'undefined' &&
    firebase.functions &&
    typeof firebase.functions === "function" &&
    storyDocId
  ) {
    const analyze = firebase.functions().httpsCallable('analyzeProgress');
    analyze({ storyId: storyDocId })
      .then(res => {
        console.log("analyzeProgress result:", res);
        const percent = res.data?.percent ?? 0;
        progress = percent;
        const bar = document.getElementById("progress-bar");
        if (bar) {
          bar.style.width = `${percent}%`;
        }
        console.log("Story completeness:", percent + "%");
      })
      .catch(error => {
        console.error("Progress analysis failed:", error.message);
      });
  }
}

    // The generateStory button and manual handler are removed.
    // Story generation is now automatic and handled in checkAndTriggerStoryGeneration and autoGenerateStory.

    // MANUAL: “Genereeri minu lugu” nupu loogika
    document.getElementById("generate-story-btn").addEventListener("click", function() {
      if (!storyDocId) {
        alert("Vestlus puudub või pole veel Firestore'i salvestatud.");
        return;
      }
      // Kuvame laadimisindikaatori
      showGeneratingStoryLoading();
      // Käivitame backend funktsiooni ja hakkame tulemust jälgima
      const generate = firebase.functions().httpsCallable('generateFullStory');
      generate({ storyId: storyDocId }).then(res => {
        if (!storyCheckInterval) {
          storyCheckInterval = setInterval(pollForStoryAndRedirect, 1500);
        }
      }).catch(err => {
        removeGeneratingStoryLoading();
        alert("Midagi läks loo genereerimisel valesti: " + (err.message || err));
      });
    });
  </script>
</body>
</html>